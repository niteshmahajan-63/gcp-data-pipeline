truncate table `sync_ctas.patients_lat_values`;

insert into `sync_ctas.patients_lat_values` (patientid, bookingdate, entitydoctorid, centreid, entityreferalid, channelid, remarks, visittype, insurerparty, doctorname, patienttypeid, lastvisitdate, nationalityid, deceased, bmi, systolic, diastolic, bmi_date, systolic_date, diastolic_date, centrename,entity_doctorname, referalname, patienttype, channel, department, nationality,encounterid)
with lat_val as( select patientid,patientremoteid,bookingdate,entitydoctorid,centreid,entityreferalid,channelid, remarks,visittype,patienttypeid, billingmetaid, departmentid,encounterid from ( select *, row_number() over(partition by patientremoteid order by bookingdate desc) as row_num from `sync_merged.items`) as tmp where row_num = 1 ) , lat_val_2 as ( select a.*,pv.lastvisitdate,b.nationalityid,b.deceased from lat_val as a left join `sync_merged.patientmerged` as b on a.patientremoteid = b.remoteid left join `sync_merged.patientvisitsummary` as pv on a.patientremoteid = pv.remoteid ) select aa.patientremoteid as patientid,aa.bookingdate,aa.entitydoctorid,aa.centreid, aa.entityreferalid,aa.channelid,aa.remarks,aa.visittype,cast(null as string) as insurerparty, cast(null as string) as doctorname,aa.patienttypeid,date(aa.lastvisitdate), aa.nationalityid,aa.deceased,null as bmi,null as systolic,null as diastolic, cast(null as TIMESTAMP) as bmi_date, cast(null as TIMESTAMP) as systolic_date,cast(null as TIMESTAMP) as diastolic_date, c.centrename as centrename, d.name as entity_doctorname, e.name as referalname, pt.value as patienttype, ch.value as channel, dep.value as department, nat.value as nationality,aa.encounterid from lat_val_2 as aa LEFT JOIN `sync_merged.billingmeta` b ON aa.billingmetaid = b.id LEFT JOIN `sync_constant.centres` c ON aa.centreid = c.id LEFT JOIN `sync_constant.entities` d ON aa.entitydoctorid = d.id LEFT JOIN `sync_constant.entities` e ON aa.entityreferalid = e.id left join `sync_constant.patienttype` as pt on aa.patienttypeid = pt.id left join `sync_constant.channel` as ch on aa.channelid = ch.id left join `sync_constant.nationality` as nat on aa.nationalityid = nat.id left join `sync_constant.department` as dep on aa.departmentid = dep.id;
