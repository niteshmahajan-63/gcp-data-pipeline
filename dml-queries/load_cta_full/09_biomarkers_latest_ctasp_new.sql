truncate table `sync_ctas.biomarkers_latest_ctasp_new`;

insert into `sync_ctas.biomarkers_latest_ctasp_new` (patientid, biomarkercode, testid, testname, bookingid,bookingdate,valued,latbookingdate,latvalued,labname,encounterid) SELECT patientid, biomarkercode, testid, testname, bookingid, resultdate as bookingdate, resultnum as valued, resultdate as latbookingdate, resultnum as latvalued, 'testclient' as labname,encounterid FROM ( SELECT patientid, biomarkercode, bookingid, testid, testname, resultdate, resultnum,encounterid, ROW_NUMBER() OVER (PARTITION BY patientid, biomarkercode ORDER BY resultdate DESC, resultnum DESC) AS rnk FROM ( SELECT a.patientremoteid as patientid, a.biomarkercode, a.bookingid, b.testid AS testid, b.testname AS testname, a.resultdate, a.resultnum,encounterid FROM `sync_merged.numeric` a JOIN `sync_merged.biomarkermeta` b ON a.biomarkermetaid = b.id where a.biomarkercode in ('b00368','b00002','b00072','b00183','b00347','b00102','b00039','b00182','b00068','b00038','b00021','b00103','b00181','b00037','b12113','b00053','b00058','b00076','b00052','b00043','b00059','b00023') ) as tmp ) as tmp_1 WHERE rnk = 1;
